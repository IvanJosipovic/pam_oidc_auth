FROM ubuntu

# Install pamtester todo remove
RUN set -xe; \
	apt-get update; \
	apt-get install -y --no-install-recommends \
		"pamtester" \
		"nano" \
	; \
	rm -fr /tmp/* ; \
	rm -rf /var/lib/apt/lists/*;

# Install pam_oidc_auth
ADD https://github.com/IvanJosipovic/pam_oidc_auth/releases/download/v1.0.0-alpha.3/pam_oidc_auth-x64.so /usr/lib/security/64/

# Add PAM config
RUN echo "auth required /usr/lib/security/64/pam_oidc_auth-x64.so discovery_url=http://oidc-server-mock:8080/.well-known/openid-configuration audience=some-app" > /etc/pam.d/oidc_auth

# pamtester -v pam_oidc_auth someuser@company.com authenticate
CMD [ "sleep", "infinity"]
#CMD [ "pamtester", "-v", "pam_oidc_auth", "someuser@company.com", "authenticate" ]